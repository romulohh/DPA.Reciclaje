CREATE DATABASE ReciclaDB;
GO

USE ReciclaDB;
GO
-- 
-- Tabla de Paises
CREATE TABLE Pais (
    IdPais INT PRIMARY KEY IDENTITY(1,1),
    Nombre VARCHAR(100) NOT NULL
);
-- Tabla de Departamentos
CREATE TABLE Departamento (
    IdDepartamento INT PRIMARY KEY IDENTITY(1,1),
    Nombre VARCHAR(100) NOT NULL,
	IdPais INT FOREIGN KEY REFERENCES Pais (IdPais)
);
-- Tabla de Provincias
CREATE TABLE Provincia (
    IdProvincia INT PRIMARY KEY IDENTITY(1,1),
    Nombre VARCHAR(100) NOT NULL,
	IdDepartamento INT FOREIGN KEY REFERENCES Departamento (IdDepartamento)
);
-- Tabla de Distritos
CREATE TABLE Distrito (
    IdDistrito INT PRIMARY KEY IDENTITY(1,1),
    Nombre VARCHAR(100) NOT NULL,
	IdDepartamento INT FOREIGN KEY REFERENCES Departamento (IdDepartamento),
    IdProvincia INT FOREIGN KEY REFERENCES Provincia (IdProvincia)
);
-- Tabla de Usuarios
CREATE TABLE Usuario (
    IdUsuario INT PRIMARY KEY IDENTITY(1,1),
    Nombres VARCHAR(100) NOT NULL,
	Apellidos VARCHAR(100) NOT NULL,
    Email VARCHAR(100) NOT NULL UNIQUE,
    Clave VARCHAR(256) NOT NULL,
    Direccion VARCHAR(255),
    IdDistrito INT FOREIGN KEY REFERENCES Distrito (IdDistrito),
	Puntuacion CHAR(1) DEFAULT 'X', -- X: Sin puntuacion, 1 al 5 puntuacion
    Rol CHAR(1) NOT NULL, -- U: Usuario (Default), A: Administrador
	Situacion CHAR(1) DEFAULT 'C', -- V: Visualizacion, C = Completa (Default)
    Estado CHAR(1) DEFAULT 'A', -- A: Activo (Default), X: Inactivo
	UltAccionVenta CHAR(1) DEFAULT 'X', -- X = Ninguna, V = Venta/Compra, D = Donación, I = Intercambio
	UltAccionCompra CHAR(1) DEFAULT 'X', -- X = Ninguna, V = Venta/Compra, D = Donación, I = Intercambio
	Imagen VARCHAR(100),
    FechaRegistro DATETIME DEFAULT GETDATE()
);
-- Tabla de Categorias
CREATE TABLE Categoria (
    IdCategoria INT PRIMARY KEY IDENTITY(1,1),
    Nombre VARCHAR(100) NOT NULL
);
-- Tabla de Productos
CREATE TABLE Producto (
    IdProducto INT PRIMARY KEY IDENTITY(1,1),
    Nombre VARCHAR(50) NOT NULL,
    Descripcion VARCHAR(200) NOT NULL,
	Marca VARCHAR(50),
    IdCategoria INT FOREIGN KEY REFERENCES Categoria (IdCategoria),
    Motivo CHAR(1), -- I = Intercambio, V = Venta, D = Donacion
	Estado CHAR(1), -- N = Nuevo, U = Usado
	Disponible CHAR(1), -- D = Disponible (Default), X = No disponible
    Precio DECIMAL(10,2),
    FechaPublicación DATETIME DEFAULT GETDATE(),
    IdUsuario INT FOREIGN KEY REFERENCES Usuario (IdUsuario)
);
-- Tabla de Imagenes
CREATE TABLE ProductoImg (
    IdProductoImg INT PRIMARY KEY IDENTITY(1,1),
	IdProducto INT FOREIGN KEY REFERENCES Producto (IdProducto),
	Imagen VARCHAR(100)
);
-- Tabla de Favoritos
CREATE TABLE Favorito (
    IdFavorito INT PRIMARY KEY IDENTITY(1,1),
    IdUsuario INT FOREIGN KEY REFERENCES Usuario (IdUsuario),
    IdProducto INT FOREIGN KEY REFERENCES Producto (IdProducto),
    Fecha DATETIME DEFAULT GETDATE()
);
-- Tabla de Notificaciones
CREATE TABLE Notificacion (
    IdNotificacion INT PRIMARY KEY IDENTITY(1,1),
    IdUsuarioVendedor INT FOREIGN KEY REFERENCES Usuario (IdUsuario), 
    IdUsuarioComprador INT FOREIGN KEY REFERENCES Usuario (IdUsuario),
    Tipo CHAR(1), -- F = Favorito, M = Comentario, C = Compra, T = Chat
    IdProducto INT FOREIGN KEY REFERENCES Producto (IdProducto),
    Fecha DATETIME DEFAULT GETDATE(),
    Leído BIT DEFAULT 0,
    Mensaje VARCHAR(255)
);
-- Tabla de Comentarios
CREATE TABLE Comentario (
    IdComentario INT PRIMARY KEY IDENTITY(1,1),
    IdUsuarioVendedor INT FOREIGN KEY REFERENCES Usuario (IdUsuario), 
    IdUsuarioComprador INT FOREIGN KEY REFERENCES Usuario (IdUsuario),
    IdProducto INT FOREIGN KEY REFERENCES Producto (IdProducto),
    Texto VARCHAR(1000),
	Calificacion CHAR(1), -- X = Sin calificar, 1 al 5 Calificacion
	Estado CHAR(1), -- P = Pendiente de publicar (Default), R = Revisado
    Fecha DATETIME DEFAULT GETDATE()
);
-- Tabla de Comentarios
CREATE TABLE ComentarioImg (
    IdComentarioImg INT PRIMARY KEY IDENTITY(1,1),
    IdComentario INT FOREIGN KEY REFERENCES Comentario (IdComentario),
	Imagen VARCHAR(100)
);
-- Tabla de chats
CREATE TABLE Chat (
    IdChat INT PRIMARY KEY IDENTITY(1,1),
    IdUsuarioVendedor INT FOREIGN KEY REFERENCES Usuario (IdUsuario), 
    IdUsuarioComprador INT FOREIGN KEY REFERENCES Usuario (IdUsuario),
    IdProducto INT FOREIGN KEY REFERENCES Producto (IdProducto),
    FechaInicio DATETIME DEFAULT GETDATE(),
    Estado CHAR(1) -- A = Activo, C = Cerrado
);
-- Tabla de mensajes del chat
CREATE TABLE ChatMensaje (
    IdChatMensaje INT PRIMARY KEY IDENTITY(1,1),
    IdChat INT FOREIGN KEY REFERENCES Chat (IdChat),
    Texto VARCHAR(100) NOT NULL,
    Fecha DATETIME DEFAULT GETDATE(),
    Leído BIT DEFAULT 0
);
-- Tabla de Campanias
CREATE TABLE [Campania] (
    [IdCampania] INT PRIMARY KEY IDENTITY(1,1),
    Título VARCHAR(100) NOT NULL,
    Descripcion VARCHAR(1000),
    FechaInicio DATETIME,
    FechaFin DATETIME,
    IdDistrito INT FOREIGN KEY REFERENCES Distrito (IdDistrito),
    IdUsuario INT FOREIGN KEY REFERENCES Usuario (IdUsuario),
    Imagen VARCHAR(100)
);
-- Tabla de imagenes por Campanias
CREATE TABLE [CampaniaImg] (
    [IdCampaniaImg] INT PRIMARY KEY IDENTITY(1,1),
	[IdCampania] INT FOREIGN KEY REFERENCES [Campania] ([IdCampania]),
    Imagen VARCHAR(100)
);
-- Tabla de Interacciones
CREATE TABLE Interaccion (
    Idinteraccion INT PRIMARY KEY IDENTITY(1,1),
    IdUsuario INT FOREIGN KEY REFERENCES Usuario (IdUsuario),
    IdProducto INT FOREIGN KEY REFERENCES Producto (IdProducto),
    Operacion CHAR(1), -- V = Venta, D = Donación, I = Intercambio
    Fecha DATETIME DEFAULT GETDATE(),
    Estado CHAR(1) -- P = Pendiente (Default), C = Completado, A = Anulado
);
-- Tabla para el carrito de compras
CREATE TABLE Carrito (
    IdCarrito INT PRIMARY KEY IDENTITY(1,1),
    IdUsuario INT FOREIGN KEY REFERENCES Usuario (IdUsuario),
    Fecha DATETIME DEFAULT GETDATE(),
    Estado CHAR(1) -- A = Activo, C = Cerrado, X = Cancelado
);
-- Tabla para el detalle del carrito de compras
CREATE TABLE CarritoProducto (
    IdCarritoItem INT PRIMARY KEY IDENTITY(1,1),
    IdCarrito INT FOREIGN KEY REFERENCES Carrito (IdCarrito),
    IdProducto INT FOREIGN KEY REFERENCES Producto (IdProducto),
    Precio DECIMAL(10,2),
    Fecha DATETIME DEFAULT GETDATE()
);
-- Tabla para los métodos de pago
CREATE TABLE MetodoPago (
    IdMetodoPago INT PRIMARY KEY IDENTITY(1,1),
    Nombre NVARCHAR(50) NOT NULL
);
-- Tabla para los pagos
CREATE TABLE Pago (
    IdPago INT PRIMARY KEY IDENTITY(1,1),
    IdCarrito INT FOREIGN KEY REFERENCES Carrito (IdCarrito),
    IdMetodoPago INT FOREIGN KEY REFERENCES MetodoPago (IdMetodoPago),
    Monto DECIMAL(10,2) NOT NULL,
    Fecha DATETIME DEFAULT GETDATE(),
	NumeroOperacion VARCHAR(20)
);
--
-- carga registros
INSERT INTO Pais (Nombre) VALUES ('Perú');
--
INSERT INTO Departamento (Nombre, IdPais)
VALUES ('Lima', 1), ('Cusco', 1), ('Arequipa', 1);
--
INSERT INTO Provincia (Nombre, IdDepartamento)
VALUES ('Lima', 1), ('Huaral', 1), ('Cusco', 2), ('Urubamba', 2), ('Arequipa', 3), ('Camana', 3);
--
INSERT INTO Distrito (Nombre, IdDepartamento, IdProvincia)
VALUES 
('Miraflores', 1, 1), 
('San Isidro', 1, 1), 
('Chancay', 1, 2), 
('Aucallama', 1, 2), 
('Santiago', 2, 3), 
('San Sebastián', 2, 3),
('Ollantaytambo', 2, 4), 
('Yucay', 2, 4), 
('Cayma', 3, 5), 
('Yanahuara', 3, 5), 
('Camana', 3, 6), 
('Mariscal Cáceres', 3, 6);

--
SELECT * FROM Usuario